# Neo4j MCP Server - API Key Authentication Proxy
# This Nginx configuration validates API keys and proxies to the MCP server
# with Basic Authentication credentials.

# Expose environment variables to Lua
env MCP_API_KEY;
env NEO4J_USERNAME;
env NEO4J_PASSWORD;

worker_processes auto;
error_log /dev/stderr info;
pid /tmp/nginx.pid;

events {
    worker_connections 256;
    use epoll;
}

http {
    # Logging to stdout/stderr for container environment
    access_log /dev/stdout combined;

    # Security hardening
    server_tokens off;

    # Request size limits to prevent abuse
    client_max_body_size 1m;
    client_body_buffer_size 16k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 8k;

    # Timeouts aligned with MCP server expectations
    proxy_connect_timeout 10s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
    client_body_timeout 10s;
    client_header_timeout 10s;
    send_timeout 10s;

    # Buffer settings for MCP responses
    proxy_buffer_size 16k;
    proxy_buffers 4 32k;
    proxy_busy_buffers_size 64k;

    # Rate limiting zone (10 requests per second per IP)
    lua_shared_dict rate_limit 10m;

    # Initialize credentials at startup
    init_by_lua_block {
        -- Load environment variables once at startup
        API_KEY = os.getenv("MCP_API_KEY") or ""
        NEO4J_USER = os.getenv("NEO4J_USERNAME") or ""
        NEO4J_PASS = os.getenv("NEO4J_PASSWORD") or ""

        -- Pre-compute Basic Auth header value
        if NEO4J_USER ~= "" and NEO4J_PASS ~= "" then
            BASIC_AUTH = ngx.encode_base64(NEO4J_USER .. ":" .. NEO4J_PASS)
        else
            BASIC_AUTH = ""
        end

        -- Log startup (credentials redacted)
        ngx.log(ngx.INFO, "API key auth proxy initialized")
        ngx.log(ngx.INFO, "API key configured: ", API_KEY ~= "" and "yes" or "no")
        ngx.log(ngx.INFO, "Basic auth configured: ", BASIC_AUTH ~= "" and "yes" or "no")
    }

    # Upstream definition for MCP server (localhost within same pod)
    upstream mcp_server {
        server 127.0.0.1:8000;
        keepalive 8;
    }

    server {
        listen 8080;
        server_name _;

        # Health check endpoint for container orchestration
        # Returns 200 if Nginx is running (does not check MCP server)
        location /health {
            access_log off;
            return 200 'healthy';
            add_header Content-Type text/plain;
        }

        # Ready check - verifies MCP server is reachable
        location /ready {
            access_log off;
            content_by_lua_block {
                local sock = ngx.socket.tcp()
                sock:settimeout(1000)
                local ok, err = sock:connect("127.0.0.1", 8000)
                if ok then
                    sock:close()
                    ngx.status = 200
                    ngx.say("ready")
                else
                    ngx.status = 503
                    ngx.say("not ready: MCP server unavailable")
                end
            }
        }

        # Main MCP endpoint - requires API key authentication
        location / {
            # Security headers
            add_header X-Content-Type-Options "nosniff" always;
            add_header X-Frame-Options "DENY" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header Referrer-Policy "strict-origin-when-cross-origin" always;

            # API key validation and rate limiting
            access_by_lua_block {
                -- Rate limiting (10 requests per second per IP)
                local limit = ngx.shared.rate_limit
                local key = ngx.var.remote_addr
                local requests, err = limit:incr(key, 1, 0, 1)
                if requests and requests > 10 then
                    ngx.log(ngx.WARN, "Rate limit exceeded for ", key)
                    ngx.status = 429
                    ngx.header["Content-Type"] = "application/json"
                    ngx.header["Retry-After"] = "1"
                    ngx.say('{"error": "Too Many Requests: Rate limit exceeded"}')
                    return ngx.exit(429)
                end

                -- Check if API key is configured
                if API_KEY == "" then
                    ngx.log(ngx.ERR, "MCP_API_KEY not configured")
                    ngx.status = 500
                    ngx.header["Content-Type"] = "application/json"
                    ngx.say('{"error": "Server misconfigured: API key not set"}')
                    return ngx.exit(500)
                end

                -- Extract API key from request headers
                local provided_key = nil
                local auth_header = ngx.req.get_headers()["Authorization"]
                local api_key_header = ngx.req.get_headers()["X-API-Key"]

                -- Check Authorization: Bearer <key> header
                if auth_header then
                    local bearer_key = auth_header:match("^[Bb]earer%s+(.+)$")
                    if bearer_key then
                        provided_key = bearer_key
                    end
                end

                -- Fall back to X-API-Key header if no Bearer token
                if not provided_key and api_key_header then
                    provided_key = api_key_header
                end

                -- Validate the API key
                if not provided_key then
                    ngx.log(ngx.WARN, "Request missing API key from ", ngx.var.remote_addr)
                    ngx.status = 401
                    ngx.header["Content-Type"] = "application/json"
                    ngx.header["WWW-Authenticate"] = 'Bearer realm="Neo4j MCP Server"'
                    ngx.say('{"error": "Unauthorized: API key required. Provide via Authorization: Bearer <key> or X-API-Key header"}')
                    return ngx.exit(401)
                end

                if provided_key ~= API_KEY then
                    ngx.log(ngx.WARN, "Invalid API key from ", ngx.var.remote_addr)
                    ngx.status = 401
                    ngx.header["Content-Type"] = "application/json"
                    ngx.header["WWW-Authenticate"] = 'Bearer realm="Neo4j MCP Server"'
                    ngx.say('{"error": "Unauthorized: Invalid API key"}')
                    return ngx.exit(401)
                end

                -- API key valid - set Basic Auth header for upstream
                if BASIC_AUTH ~= "" then
                    ngx.req.set_header("Authorization", "Basic " .. BASIC_AUTH)
                else
                    -- Clear the Authorization header if no Basic Auth configured
                    ngx.req.clear_header("Authorization")
                end
            }

            # Proxy to MCP server
            proxy_pass http://mcp_server;
            proxy_http_version 1.1;

            # Headers for proper proxying
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Support for streaming responses (SSE)
            proxy_set_header Connection '';
            proxy_buffering off;
            proxy_cache off;
            chunked_transfer_encoding on;
        }
    }
}
